clear all;
load("mnist.mat");

%Taken from Week One
%Swap Test and Train
XTestReshape = reshape(XTest,28,28,10000);
XTestReshapeForDiv = reshape(XTestReshape, [], 10000);
XTestReshapeTrans = transpose(XTestReshapeForDiv);
YTestTrans = transpose(YTest);
C = mrdivide(XTestReshapeForDiv,YTestTrans);
CTrans = transpose(C);
YHatTest = (XTestReshapeTrans * C);
YHatTestTrans = transpose(YHatTest);

d = YTestTrans - (CTrans * XTestReshapeForDiv);
nFull = size(YTestTrans);
n = nFull(1,2);

mse = mean(abs(YHatTest - YTest));

%y_k = (CTrans * XTestReshapeForDiv);
%Everything past this point comes out as a list of zeros
maxError = abs(YHatTest - YTest);
l_two = lTwoNorm(YHatTest,YTest,n);
l_one = lOneNorm(YHatTest,YTest,n);
mnistRidge = ridge(YHatTest,YTest,5);
mnistLasso = lasso(YHatTest,YTest);
L = genLoss(C,d,YTest,YHatTest,n,1,2);

x0 = [1,1];
fminGL = fminsearch(@(YHatTest) genLoss(C,d,YTest,YHatTest,n,1,2),x0);
fminLT = fminsearch(@(YHatTest) lOneNorm(YHatTest,YTest,n),x0);
fminLO = fminsearch(@(YHatTest) lTwoNorm(YHatTest,YTest,n),x0);

vecMat = ones(784,1);
vecTrain = ones(60000,1);
vecTest = ones(10000,1);

CTestGL = polyval(fminGL,vecMat);
dTestGL = polyval(fminGL,vecTest);
%Wouldn't work till I moved it the other way round
ykGL = (XTestReshapeTrans * CTestGL) + dTestGL;
CTestLT = polyval(fminLT,vecMat);
dTestLT = polyval(fminLT,vecTest);
ykLT = (XTestReshapeTrans * CTestLT) + dTestLT;
CTestLO = polyval(fminLO,vecMat);
dTestLO = polyval(fminLO,vecTest);
ykO = (XTestReshapeTrans * CTestLO) + dTestLO;

yCheck = ones(10000,3);
yCheck(:,1) = ykGL;
yCheck(:,2) = ykLT;
yCheck(:,3) = ykO;
imagesc(yCheck);

%One Hot Encode
digits = ["One","Two","Three","Four","Five","Six","Seven","Eight","Nine","Ten"];
digits = categorical(digits);
categories(digits);
digits = onehotencode(digits,1);
XTestReshapeOHE = reshape(XTestReshape, [], 10);
XTestReshapeOHETrans = transpose(XTestReshapeOHE);
digitsVec = reshape(digits,[],1);
cOHE = mrdivide(XTestReshapeOHE,digits);
YHatOHE = (XTestReshapeOHETrans * cOHE);
YHatOHEVec = reshape(YHatOHE,[],1);

nFullOHE = size(digits);
nOHE = nFullOHE(1,2);
mseOHE = mean(abs(YHatOHE - digits));
maxErrorOHE = abs(YHatOHE - digits);
l_twoOHE = lTwoNorm(YHatOHE,digits,nOHE);
l_oneOHE = lOneNorm(YHatOHE,digits,nOHE);
mnistRidgeOHE = ridge(YHatOHEVec,digitsVec,5);

function l_two = lTwoNorm(y_k,YTestTrans,n)
  coef = 1/n;
  brac = abs(y_k - YTestTrans);
  bracsq = brac.^2;
  bracsum = sum(bracsq,"all");
  rootsum = sqrt(bracsum);
  l_two = coef * rootsum;
end

function l_one = lOneNorm(y_k,YTestTrans,n)
  coef = 1/n;
  brac = y_k - YTestTrans;
  bracsum = sum(brac,"all");
  l_one = coef * bracsum;
end

function L = genLoss(x,d,Y,YHat,n,lambdaOne,lambdaTwo)
    problemLTwo = lTwoNorm(YHat,Y,n);
    lOne = lOneNorm(d,x,n);
    lTwo = lTwoNorm(d,x,n);
    L = problemLTwo + (lambdaOne * lOne) + (lambdaTwo * lTwo);
end
